<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pernod Ricard ‚Äî Mini App</title>
  <meta name="theme-color" content="#0a84ff" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{ --bg:#f6f6f9; --card:#ffffff; --text:#111; --muted:#666; --accent:#0a84ff; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{background:var(--bg);display:flex;align-items:center;justify-content:center;padding:24px}
    .wrap{width:100%;max-width:520px}
    .brand{display:flex;align-items:center;gap:10px;margin:0 auto 16px;justify-content:center;opacity:.9}
    .brand .logo{width:36px;height:36px;border-radius:10px;background:var(--accent);box-shadow:0 6px 16px rgba(0,0,0,.12)}
    .brand .name{font-weight:700;letter-spacing:.4px;color:var(--text)}
    .card{background:var(--card);border-radius:20px;box-shadow:0 12px 36px rgba(0,0,0,.10);padding:28px 22px;text-align:center}
    .eyebrow{font-size:12px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin:0 0 8px}
    h1{margin:0 0 8px;font-size:24px;color:var(--text)}
    .sub{margin:0 auto 18px;max-width:34ch;line-height:1.45;color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#00000008;color:var(--muted);font-size:13px;margin-bottom:14px}
    .btn{width:100%;padding:14px 16px;border:0;border-radius:14px;background:var(--accent);color:#fff;font-weight:600;font-size:16px;cursor:pointer;box-shadow:0 10px 20px rgba(10,132,255,.25);transition:transform .06s ease}
    .btn:active{transform:translateY(1px)}
    .footer{margin-top:14px;font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div class="name">Pernod Ricard</div>
    </div>

    <div class="card">
      <p class="eyebrow">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</p>
      <h1 id="title">–ü—Ä–∏–≤–µ—Ç, –≥–æ—Å—Ç—å!</h1>
      <p class="sub">–≠—Ç–æ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–æ–≤ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏: –∫–≤–∏–∑—ã, –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è, –∞—É–∫—Ü–∏–æ–Ω –ø—Ä–∏–∑–æ–≤.</p>
      <div class="pill" id="sessionHint">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è‚Ä¶</div>
      <button class="btn" id="startBtn">–ù–∞—á–∞—Ç—å</button>
      <div class="footer">–†–∞–±–æ—Ç–∞–µ—Ç –≤–Ω—É—Ç—Ä–∏ Telegram Mini App</div>
    </div>
  </div>

  <script>
    const EVENT_SLUG = 'pr-demo';

    // Telegram API + —Ç–µ–º–∞
    const tg = window.Telegram?.WebApp; tg?.expand();
    const tp = tg?.themeParams || {};
    const pick = (k, fb) => (tp[k] ? (tp[k].startsWith('#') ? tp[k] : '#'+tp[k]) : fb);
    document.documentElement.style.setProperty('--bg',     pick('bg_color',       getComputedStyle(document.documentElement).getPropertyValue('--bg')));
    document.documentElement.style.setProperty('--card',   pick('secondary_bg_color', '#ffffff'));
    document.documentElement.style.setProperty('--text',   pick('text_color',     '#111'));
    document.documentElement.style.setProperty('--muted',  pick('hint_color',     '#666'));
    document.documentElement.style.setProperty('--accent', pick('button_color',   '#0a84ff'));

    // –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    const user = tg?.initDataUnsafe?.user;
    title.textContent = user ? `–ü—Ä–∏–≤–µ—Ç, ${user.first_name}!` : '–ü—Ä–∏–≤–µ—Ç, –≥–æ—Å—Ç—å!';
    sessionHint.textContent = user ? `ID ${user.id} ‚Ä¢ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é‚Ä¶` : '–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram';

    // helpers (–í–ê–ñ–ù–û: .js –≤ –ø—É—Ç—è—Ö)
    async function post(path, data){
      const r = await fetch(`/api/${path}.js`, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(data || {})
      });
      if (!r.ok) throw new Error(`${path} ${r.status}`);
      return r.json();
    }
    async function get(path, params){
      const q = new URLSearchParams(params || {}).toString();
      const r = await fetch(`/api/${path}.js${q ? `?${q}` : ''}`);
      if (!r.ok) throw new Error(`${path} ${r.status}`);
      return r.json();
    }

    // –±–∞–∑–æ–≤–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è + –ø—É–ª—å—Å –æ–Ω–ª–∞–π–Ω–∞
    if (user) {
      post('register', { tg_id:user.id, username:user.username, display_name:user.first_name }).catch(console.log);
      setInterval(() => post('ping', { tg_id:user.id }).catch(console.log), 10000);
    }

    // —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ —Å–æ–±—ã—Ç–∏–∏ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ –µ—â—ë –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω)
    async function ensureParticipant(){
      if (!user) return;

      // 1) –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É—á–∞—Å—Ç–Ω–∏–∫ –≤ —Å–æ–±—ã—Ç–∏–∏
      const me = await get('event/me', { tg_id:user.id, event_slug: EVENT_SLUG }).catch(console.log);
      if (me?.registered) {
        sessionHint.textContent = `–ì–æ—Ç–æ–≤–æ ‚Ä¢ –ë–∞–ª–∞–Ω—Å: ${me.participant.score}`;
        return;
      }

      // 2) –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –∞–≤—Ç–æ-join —Å –ø—Ä–æ—Å—Ç—ã–º —ç–º–æ–¥–∑–∏-–∞–≤–∞—Ç–∞—Ä–æ–º
      const avatars = ['üêª','ü¶ä','üê±','ü¶â','üêº','ü¶Å','üêØ','üê®'];
      const avatar = avatars[Math.floor(Math.random()*avatars.length)];
      try {
        await post('event/join', {
          tg_id: user.id,
          username: user.username,
          display_name: user.first_name,
          avatar_url: avatar,
          event_slug: EVENT_SLUG
        });
        const after = await get('event/me', { tg_id:user.id, event_slug: EVENT_SLUG });
        sessionHint.textContent = `–£—Å–ø–µ—à–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Ä¢ –ë–∞–ª–∞–Ω—Å: ${after.participant.score}`;
      } catch (e) {
        console.log(e);
        sessionHint.textContent = '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
      }
    }

    ensureParticipant();

    // –∫–Ω–æ–ø–∫–∞
    startBtn.addEventListener('click', () => {
      try { tg?.HapticFeedback?.impactOccurred('medium'); } catch{}
      tg?.showAlert?.('–î–∞–ª—å—à–µ: –õ–æ–±–±–∏ ‚Üí –≤—ã–±–æ—Ä –∏–≥—Ä—ã ‚Üí –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤.');
    });
  </script>
</body>
</html>
