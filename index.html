<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pernod Ricard ‚Äî Mini App</title>
  <meta name="theme-color" content="#0a84ff" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{ --bg:#f6f6f9; --card:#ffffff; --text:#111; --muted:#666; --accent:#0a84ff; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{background:var(--bg);display:flex;align-items:center;justify-content:center;padding:24px}
    .wrap{width:100%;max-width:640px}
    .brand{display:flex;align-items:center;gap:10px;margin:0 auto 16px;justify-content:center;opacity:.9}
    .brand .logo{width:36px;height:36px;border-radius:10px;background:var(--accent);box-shadow:0 6px 16px rgba(0,0,0,.12)}
    .brand .name{font-weight:700;letter-spacing:.4px;color:var(--text)}
    .card{background:var(--card);border-radius:20px;box-shadow:0 12px 36px rgba(0,0,0,.10);padding:24px}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .user{display:flex;gap:10px;align-items:center}
    .ava{width:40px;height:40px;border-radius:999px;background:#f1f3f7;display:flex;align-items:center;justify-content:center;font-size:20px}
    .name{font-weight:700}
    .score{font-weight:700;color:var(--accent)}
    .grid{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:12px;margin-top:16px}
    .btn{padding:14px 16px;border:0;border-radius:14px;background:#0a84ff;color:#fff;font-weight:600;font-size:16px;cursor:pointer;box-shadow:0 10px 20px rgba(10,132,255,.25)}
    .btn:disabled{background:#b9c8ff;color:#eee;cursor:not-allowed;box-shadow:none}
    .muted{color:var(--muted);font-size:13px;margin-top:10px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div class="name">Pernod Ricard</div>
    </div>

    <div class="card">
      <div class="row">
        <div class="user">
          <div class="ava" id="ava">üôÇ</div>
          <div>
            <div class="name" id="uname">–ì–æ—Å—Ç—å</div>
            <div class="muted" id="ustatus">–ü—Ä–æ–≤–µ—Ä–∫–∞‚Ä¶</div>
          </div>
        </div>
        <div class="score" id="uscore">–ë–∞–ª–∞–Ω—Å: ‚Äî</div>
      </div>

      <div class="grid">
        <button class="btn" id="btnQuiz" disabled>–ö–≤–∏–∑</button>
        <button class="btn" id="btnLogic" disabled>–ì–¥–µ –ª–æ–≥–∏–∫–∞?</button>
        <button class="btn" id="btnContact" disabled>–ï—Å—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç!</button>
        <button class="btn" id="btn100" disabled>100 –∫ 1</button>
        <button class="btn" id="btnAuction" disabled>–ê—É–∫—Ü–∏–æ–Ω</button>
      </div>

      <div class="muted" id="phase">–§–∞–∑–∞: lobby</div>
    </div>
  </div>

  <script>
    const EVENT_SLUG = 'pr-demo';
    const tg = window.Telegram?.WebApp; tg?.expand();

    const tp = tg?.themeParams || {};
    const pick = (k, fb) => (tp[k] ? (tp[k].startsWith('#') ? tp[k] : '#'+tp[k]) : fb);
    document.documentElement.style.setProperty('--bg',     pick('bg_color',       getComputedStyle(document.documentElement).getPropertyValue('--bg')));
    document.documentElement.style.setProperty('--card',   pick('secondary_bg_color', '#ffffff'));
    document.documentElement.style.setProperty('--text',   pick('text_color',     '#111'));
    document.documentElement.style.setProperty('--muted',  pick('hint_color',     '#666'));
    document.documentElement.style.setProperty('--accent', pick('button_color',   '#0a84ff'));

    const user = tg?.initDataUnsafe?.user;
    const uname = document.getElementById('uname');
    const ustatus = document.getElementById('ustatus');
    const uscore = document.getElementById('uscore');
    const avaEl = document.getElementById('ava');

    uname.textContent = user ? (user.first_name || '–£—á–∞—Å—Ç–Ω–∏–∫') : '–ì–æ—Å—Ç—å';
    ustatus.textContent = user ? `ID ${user.id}` : '–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram';

    async function post(path, data){
      const r = await fetch(`/api/${path}.js`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(data || {})
      });
      if (!r.ok) throw new Error(`${path} ${r.status}`);
      return r.json();
    }
    async function get(path, params){
      const q = new URLSearchParams(params || {}).toString();
      const r = await fetch(`/api/${path}.js${q ? '?'+q : ''}`);
      if (!r.ok) throw new Error(`${path} ${r.status}`);
      return r.json();
    }

    if (user) {
      post('register', { tg_id:user.id, username:user.username, display_name:user.first_name }).catch(console.log);
      setInterval(()=>post('ping', { tg_id:user.id }).catch(console.log), 10000);
    }

    async function ensureParticipant(){
      if (!user) return;
      const me = await get('event/me', { tg_id:user.id, event_slug:EVENT_SLUG }).catch(console.log);
      if (me?.registered) {
        avaEl.textContent = me.participant.avatar_url || 'üôÇ';
        uscore.textContent = '–ë–∞–ª–∞–Ω—Å: ' + me.participant.score;
        ustatus.textContent = '–£—á–∞—Å—Ç–Ω–∏–∫ —Å–æ–±—ã—Ç–∏—è';
        return true;
      } else {
        const avatars = ['üêª','ü¶ä','üê±','ü¶â','üêº','ü¶Å','üêØ','üê®'];
        const avatar = avatars[Math.floor(Math.random()*avatars.length)];
        await post('event/join', {
          tg_id:user.id, username:user.username,
          display_name:user.first_name, avatar_url:avatar,
          event_slug:EVENT_SLUG
        }).catch(console.log);
        const again = await get('event/me', { tg_id:user.id, event_slug:EVENT_SLUG });
        avaEl.textContent = again.participant.avatar_url || 'üôÇ';
        uscore.textContent = '–ë–∞–ª–∞–Ω—Å: ' + again.participant.score;
        ustatus.textContent = '–£—á–∞—Å—Ç–Ω–∏–∫ —Å–æ–±—ã—Ç–∏—è';
        return true;
      }
    }

    async function pollState(){
      try{
        const s = await get('event/state', { event_slug:EVENT_SLUG });
        const st = s.state;
        document.getElementById('phase').textContent = '–§–∞–∑–∞: ' + st.phase;

        btnQuiz.disabled     = !st.quiz_open;
        btnLogic.disabled    = !st.logic_open;
        btnContact.disabled  = !st.contact_open;
        btn100.disabled      = !st.onehundred_open;
        btnAuction.disabled  = !st.auction_open;
      }catch(e){ console.log(e); }
    }

    // –∫–ª–∏–∫–∏
    btnQuiz.onclick = async () => {
      try {
        const resp = await post('quiz', { tg_id: user?.id || null });
        tg?.showAlert?.(resp.message || '–û–∫');
      } catch (e) {
        tg?.showAlert?.('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
      }
    };
    btnLogic.onclick   = ()=> tg?.showAlert?.('–ì–¥–µ –ª–æ–≥–∏–∫–∞? (—Å–∫–æ—Ä–æ)');
    btnContact.onclick = ()=> tg?.showAlert?.('–ï—Å—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç! (—Å–∫–æ—Ä–æ)');
    btn100.onclick     = ()=> tg?.showAlert?.('100 –∫ 1 (—Å–∫–æ—Ä–æ)');
    btnAuction.onclick = ()=> tg?.showAlert?.('–ê—É–∫—Ü–∏–æ–Ω (—Å–∫–æ—Ä–æ)');

    (async ()=>{
      if (user) await ensureParticipant();
      await pollState();
      setInterval(pollState, 3000);
    })();
  </script>
</body>
</html>
