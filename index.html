<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Pernod Ricard ‚Äî Mini App</title>
    <meta name="theme-color" content="#0d172a" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      :root {
        --bg: #0d172a;
        --card: #0f1b31;
        --line: #1d2a47;
        --text: #eef3ff;
        --muted: #9fb0d1;
        --accent: #4c8dff;
        --ok: #39d98a;
        --err: #ff6b6b;
        --shadow: 0 14px 40px rgba(6, 17, 38, 0.35);
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      }
      .wrap {
        max-width: 720px;
        margin: 0 auto;
        padding: 20px;
      }
      .logoRow {
        display: flex;
        align-items: center;
        justify-content: center; /* —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ */
        gap: 10px;
        opacity: 0.9;
        margin: 20px 0 20px; /* —á—É—Ç—å –±–æ–ª—å—à–µ –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É/—Å–Ω–∏–∑—É */
      }
      .logoRow img {
        height: 40px;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 16px;
        box-shadow: var(--shadow);
        padding: 18px;
      }
      .head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 12px;
      }
      .user {
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 0;
      }
      .ava {
        width: 44px;
        height: 44px;
        border-radius: 999px;
        background: #1b2a49;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        border: 1px solid var(--line);
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
      }
      .ava img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .ava span {
        font-size: 22px;
        opacity: 0.9;
      }
      .uinfo {
        min-width: 0;
      }
      .uname {
        font-weight: 700;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .ustatus {
        color: var(--muted);
        font-size: 12px;
      }
      .badge {
        background: #122141;
        border: 1px solid var(--line);
        color: #bcd2ff;
        padding: 8px 12px;
        border-radius: 12px;
        font-weight: 700;
        white-space: nowrap;
      }
      .phase {
        text-align: center;
        margin: 8px 0 14px;
      }
      .phase .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #0a142a;
        border: 1px solid var(--line);
        padding: 8px 12px;
        border-radius: 999px;
      }
      .muted {
        color: var(--muted);
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
      }
      .tile {
        background: linear-gradient(180deg, #122243, #0f1b31);
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-height: 104px;
        transition: transform 0.08s ease, box-shadow 0.12s ease,
          border-color 0.12s ease;
        cursor: pointer;
      }
      .tile:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 26px rgba(0, 0, 0, 0.22);
      }
      .tile:active {
        transform: translateY(1px);
      }
      .tile h3 {
        color: #ffffff;
        margin: 0;
        font-size: 16px;
      }
      .tile p {
        margin: 0;
        color: var(--muted);
        font-size: 13px;
      }
      .tile.disabled {
        opacity: 0.5;
        filter: grayscale(0.1);
        cursor: not-allowed;
      }
      .tile.disabled:hover {
        transform: none;
        box-shadow: none;
      }
      .cta {
        background: var(--accent);
        color: #fff;
        border: 0;
        border-radius: 12px;
        padding: 14px 16px;
        font-weight: 700;
        cursor: pointer;
        width: 100%;
        box-shadow: 0 12px 26px rgba(76, 141, 255, 0.35);
      }
      .cta:active {
        transform: translateY(1px);
      }
      .foot {
        margin-top: 12px;
        text-align: center;
        color: var(--muted);
        font-size: 12px;
      }
      .ghost {
        background: transparent;
        border: 1px solid var(--line);
        color: var(--text);
        padding: 12px 14px;
        border-radius: 12px;
        cursor: pointer;
      }
      .tiny {
        padding: 6px 8px;
        border-radius: 10px;
        font-size: 12px;
      }

      /* Intro */
      .intro {
        position: fixed;
        inset: 0;
        background: linear-gradient(180deg, #0a1326, #0d172a);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 28px;
        z-index: 10;
      }
      .intro .box {
        max-width: 720px;
        width: 100%;
      }
      .intro .hero {
        text-align: center;
        margin-bottom: 16px;
      }
      .intro .hero img {
        height: 40px;
        opacity: 0.95;
      }
      .intro .card {
        padding: 22px;
      }
      .intro h1 {
        margin: 0 0 8px;
        font-size: 22px;
      }
      .intro p {
        margin: 6px 0 0;
        color: var(--muted);
      }
      .intro .actions {
        display: flex;
        gap: 10px;
        margin-top: 16px;
      }

      @media (max-width: 440px) {
        .grid {
          grid-template-columns: 1fr;
        }
        .badge {
          padding: 8px 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <!-- brand -->
      <div class="logoRow" id="brandTap">
        <img
          alt="Pernod Ricard"
          src="https://www.pernod-ricard.com/themes/custom/pr2021_front/assets/images/logo50/logo-white-50.svg"
        />
      </div>

      <!-- INTRO -->
      <section class="intro" id="intro" style="display: none">
        <div class="box">
          <div class="hero">
            <img
              alt="Pernod Ricard"
              src="https://www.pernod-ricard.com/themes/custom/pr2021_front/assets/images/logo50/logo-white-50.svg"
            />
          </div>
          <div class="card">
            <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>
            <p>
              –≠—Ç–æ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–æ–≤ –Ω–∞ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏: –∫–≤–∏–∑—ã, ¬´–ì–¥–µ
              –ª–æ–≥–∏–∫–∞?¬ª, ¬´–ï—Å—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç!¬ª, ¬´100 –∫ 1¬ª –∏ –∞—É–∫—Ü–∏–æ–Ω.
            </p>
            <p class="muted">
              –ù–∞–∂–∏–º–∞—è ¬´–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å¬ª, –≤—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ—Ç–µ—Å—å –∫ —Å–æ–±—ã—Ç–∏—é –∏ –≤–∏–¥–∏—Ç–µ
              –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.
            </p>
            <div class="actions">
              <button id="introStart" class="cta">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
              <button id="introLater" class="ghost">–ü–æ—Ç–æ–º</button>
            </div>
          </div>
        </div>
      </section>

      <!-- MAIN -->
      <section class="card">
        <div class="head">
          <div class="user">
            <div class="ava" id="ava"><span>üôÇ</span></div>
            <div class="uinfo">
              <div class="uname" id="uname">–ì–æ—Å—Ç—å</div>
              <div class="ustatus" id="ustatus">–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram</div>
            </div>
          </div>
          <div class="badge" id="balance">–ë–∞–ª–∞–Ω—Å: ‚Äî</div>
        </div>

        <div class="phase">
          <div class="pill">
            –§–∞–∑–∞: <b id="phaseText" style="margin-left: 6px">lobby</b>
          </div>
          <div class="muted" id="upd" style="margin-top: 6px">‚Äî</div>
        </div>

        <div class="grid" style="margin-top: 14px">
          <button class="tile" id="btnQuiz">
            <h3>–ö–≤–∏–∑</h3>
            <p>–†–∞—É–Ω–¥—ã —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–æ–≤</p>
          </button>
          <button class="tile" id="btnLogic">
            <h3>–ì–¥–µ –ª–æ–≥–∏–∫–∞?</h3>
            <p>–£–∑–Ω–∞–π, —á—Ç–æ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏</p>
          </button>
          <button class="tile" id="btnContact">
            <h3>–ï—Å—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç!</h3>
            <p>–ö–æ–º–∞–Ω–¥–Ω—ã–µ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ ‚Äî –Ω–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–æ</p>
          </button>
          <button class="tile" id="btn100">
            <h3>100 –∫ 1</h3>
            <p>–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –Ω–µ–æ–±—ã—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã</p>
          </button>
          <button class="tile" id="btnAuction" style="grid-column: 1/-1">
            <h3>–ê—É–∫—Ü–∏–æ–Ω</h3>
            <p>–°—Ç–∞–≤—å –±–∞–ª–ª—ã ‚Äî –∑–∞–±–∏—Ä–∞–π –ø—Ä–∏–∑—ã</p>
          </button>
        </div>

        <div class="foot">
          –†–∞–±–æ—Ç–∞–µ—Ç –≤–Ω—É—Ç—Ä–∏ Telegram Mini App
          <!-- —Å–∫—Ä—ã—Ç–∞—è —Ç–µ—Å—Ç–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ -->
          <button
            id="resetIntro"
            class="ghost tiny"
            style="display: none; margin-left: 8px"
          >
            –°–±—Ä–æ—Å–∏—Ç—å –∏–Ω—Ç—Ä–æ
          </button>
        </div>
      </section>
    </div>

    <script>
      const EVENT_SLUG = "pr-demo";
      const tg = window.Telegram?.WebApp;
      tg?.expand?.();

      // –ø—Ä–∏–º–µ–Ω–∏–º —Ç–µ–º—É Telegram, –µ—Å–ª–∏ –∑–∞–¥–∞–Ω–∞
      try {
        const tp = tg?.themeParams || {};
        const pick = (k, fb) =>
          tp[k] ? (tp[k].startsWith("#") ? tp[k] : "#" + tp[k]) : fb;
        document.documentElement.style.setProperty(
          "--bg",
          pick(
            "bg_color",
            getComputedStyle(document.documentElement).getPropertyValue("--bg")
          )
        );
        document.documentElement.style.setProperty(
          "--text",
          pick("text_color", "#eef3ff")
        );
        document.documentElement.style.setProperty(
          "--muted",
          pick("hint_color", "#9fb0d1")
        );
        document.documentElement.style.setProperty(
          "--card",
          pick("secondary_bg_color", "#0f1b31")
        );
        document.documentElement.style.setProperty(
          "--accent",
          pick("button_color", "#4c8dff")
        );
      } catch {}

      // ----------------- helpers -----------------
      async function post(path, data) {
        const r = await fetch(`/api/${path}.js`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data || {}),
        });
        if (!r.ok) throw new Error(path + " " + r.status);
        return r.json();
      }
      async function get(path, params) {
        const q = new URLSearchParams(params || {}).toString();
        const r = await fetch(`/api/${path}.js${q ? "?" + q : ""}`);
        if (!r.ok) throw new Error(path + " " + r.status);
        return r.json();
      }

      // ----------------- intro -----------------
      const INTRO_KEY = "pr_seen_intro_v1";
      // –ü–∞—Ä–∞–º–µ—Ç—Ä ?intro=reset –∏ ?debug=1
      try {
        const q = new URLSearchParams(location.search);
        if (q.get("intro") === "reset") localStorage.removeItem(INTRO_KEY);
        if (q.get("debug") === "1")
          document.getElementById("resetIntro").style.display = "inline-flex";
      } catch {}

      const $intro = document.getElementById("intro");
      const $introStart = document.getElementById("introStart");
      const $introLater = document.getElementById("introLater");
      const $resetIntro = document.getElementById("resetIntro");

      function showIntroIfNeeded() {
        if (!localStorage.getItem(INTRO_KEY)) {
          $intro.style.display = "flex";
        }
      }
      $introStart.onclick = () => {
        localStorage.setItem(INTRO_KEY, "1");
        $intro.style.display = "none";
        tg?.HapticFeedback?.impactOccurred("medium");
      };
      $introLater.onclick = () => {
        $intro.style.display = "none";
      };
      $resetIntro.onclick = () => {
        localStorage.removeItem(INTRO_KEY);
        $intro.style.display = "flex";
        tg?.HapticFeedback?.notificationOccurred?.("success");
      };

      // –°–∫—Ä—ã—Ç—ã–π –∂–µ—Å—Ç: 5 –±—ã—Å—Ç—Ä—ã—Ö —Ç–∞–ø–æ–≤ –ø–æ –ª–æ–≥–æ—Ç–∏–ø—É ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É —Ä–µ—Å–µ—Ç–∞
      (function () {
        const el = document.getElementById("brandTap");
        let taps = 0,
          timer;
        el?.addEventListener("click", () => {
          clearTimeout(timer);
          taps++;
          timer = setTimeout(() => (taps = 0), 800);
          if (taps >= 5) {
            document.getElementById("resetIntro").style.display = "inline-flex";
            tg?.HapticFeedback?.impactOccurred?.("light");
          }
        });
      })();

      // ----------------- user / join -----------------
      const user = tg?.initDataUnsafe?.user;
      const uname = document.getElementById("uname");
      const ustatus = document.getElementById("ustatus");
      const balance = document.getElementById("balance");
      const avaEl = document.getElementById("ava");

      uname.textContent = user ? user.first_name || "–£—á–∞—Å—Ç–Ω–∏–∫" : "–ì–æ—Å—Ç—å";
      ustatus.textContent = user ? `ID ${user.id}` : "–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram";

      function setAva({ photo_url, emoji } = {}) {
        avaEl.innerHTML = "";
        if (photo_url) {
          const img = new Image();
          img.src = photo_url;
          img.alt = "avatar";
          img.onload = () => avaEl.appendChild(img);
          img.onerror = () => (avaEl.innerHTML = "<span>üôÇ</span>");
        } else if (emoji) {
          avaEl.innerHTML = `<span>${emoji}</span>`;
        } else {
          avaEl.innerHTML = `<span>üôÇ</span>`;
        }
      }

      async function ensureJoined() {
        if (!user) return;
        await post("register", {
          tg_id: user.id,
          username: user.username,
          display_name: user.first_name,
        }).catch(() => {});
        const me = await get("event/me", {
          tg_id: user.id,
          event_slug: EVENT_SLUG,
        }).catch(() => null);
        if (me?.registered) {
          balance.textContent = "–ë–∞–ª–∞–Ω—Å: " + me.participant.score;
          setAva({
            photo_url: user.photo_url || null,
            emoji: me.participant.avatar_url || "üôÇ",
          });
          ustatus.textContent = "–£—á–∞—Å—Ç–Ω–∏–∫ —Å–æ–±—ã—Ç–∏—è";
          return;
        }
        const avatars = [
          "üêª",
          "ü¶ä",
          "üê±",
          "ü¶â",
          "üêº",
          "ü¶Å",
          "üêØ",
          "üê®",
          "ü¶Ñ",
          "üêµ",
        ];
        const avatar = avatars[Math.floor(Math.random() * avatars.length)];
        await post("event/join", {
          tg_id: user.id,
          username: user.username,
          display_name: user.first_name,
          avatar_url: avatar,
          event_slug: EVENT_SLUG,
        }).catch(() => {});
        const again = await get("event/me", {
          tg_id: user.id,
          event_slug: EVENT_SLUG,
        }).catch(() => null);
        if (again?.participant) {
          balance.textContent = "–ë–∞–ª–∞–Ω—Å: " + again.participant.score;
          setAva({
            photo_url: user.photo_url || null,
            emoji: again.participant.avatar_url || "üôÇ",
          });
          ustatus.textContent = "–£—á–∞—Å—Ç–Ω–∏–∫ —Å–æ–±—ã—Ç–∏—è";
        }
      }

      // –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –æ–Ω–ª–∞–π–Ω-–ø—É–ª—å—Å
      if (user) {
        setInterval(
          () => post("ping", { tg_id: user.id }).catch(() => {}),
          10000
        );
      }

      // ----------------- state poll -----------------
      const phaseText = document.getElementById("phaseText");
      const upd = document.getElementById("upd");

      const btnQuiz = document.getElementById("btnQuiz");
      const btnLogic = document.getElementById("btnLogic");
      const btnContact = document.getElementById("btnContact");
      const btn100 = document.getElementById("btn100");
      const btnAuction = document.getElementById("btnAuction");

      function setEnabled(el, on) {
        el.classList.toggle("disabled", !on);
        el.disabled = !on;
      }

      async function pollState() {
        try {
          const s = await get("event/state", { event_slug: EVENT_SLUG });
          const st = s.state || {};
          phaseText.textContent = st.phase || "lobby";
          upd.textContent =
            "–û–±–Ω–æ–≤–ª–µ–Ω–æ: " +
            (st.updated_at
              ? new Date(st.updated_at).toLocaleTimeString()
              : "‚Äî");
          setEnabled(btnQuiz, !!st.quiz_open);
          setEnabled(btnLogic, !!st.logic_open);
          setEnabled(btnContact, !!st.contact_open);
          setEnabled(btn100, !!st.onehundred_open);
          setEnabled(btnAuction, !!st.auction_open);
        } catch {}
      }

      // –∫–ª–∏–∫–∏ (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∏)
      btnQuiz.onclick = () => {
        if (btnQuiz.disabled) return;
        tg?.showAlert?.("–ö–≤–∏–∑: —Å–∫–æ—Ä–æ —ç–∫—Ä–∞–Ω –≤–æ–ø—Ä–æ—Å–æ–≤.");
        tg?.HapticFeedback?.impactOccurred("light");
      };
      btnLogic.onclick = () => {
        if (btnLogic.disabled) return;
        tg?.showAlert?.("–ì–¥–µ –ª–æ–≥–∏–∫–∞? ‚Äî —Å–∫–æ—Ä–æ.");
      };
      btnContact.onclick = () => {
        if (btnContact.disabled) return;
        tg?.showAlert?.("–ï—Å—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç! ‚Äî —Å–∫–æ—Ä–æ.");
      };
      btn100.onclick = () => {
        if (btn100.disabled) return;
        tg?.showAlert?.("100 –∫ 1 ‚Äî —Å–∫–æ—Ä–æ.");
      };
      btnAuction.onclick = () => {
        if (btnAuction.disabled) return;
        tg?.showAlert?.("–ê—É–∫—Ü–∏–æ–Ω ‚Äî —Å–∫–æ—Ä–æ.");
      };

      // boot
      (async () => {
        // –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É —Ä–µ—Å–µ—Ç–∞, –µ—Å–ª–∏ ?debug=1 —É–∂–µ –ø—Ä–∏–º–µ–Ω—ë–Ω –≤—ã—à–µ
        // –∏/–∏–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç—Ä–æ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–ª—é—á–∞
        if (user) await ensureJoined();
        if (!localStorage.getItem(INTRO_KEY)) {
          document.getElementById("intro").style.display = "flex";
        }
        setInterval(pollState, 3000);
        pollState();
      })();
    </script>
  </body>
</html>
