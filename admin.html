<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <title>Admin ‚Ä¢ Pernod Ricard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #0b1020;
        --card: #121a2a;
        --text: #e9eefc;
        --muted: #96a0b8;
        --accent: #4c8dff;
        --ok: #39d98a;
        --err: #ff6b6b;
        --line: #1e2840;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      }
      .wrap {
        max-width: 1180px;
        margin: 24px auto;
        padding: 0 16px;
      }
      h1 {
        font-size: 20px;
        margin: 0 0 16px;
      }
      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .kv {
        display: grid;
        grid-template-columns: 140px 1fr;
        gap: 8px;
        align-items: center;
        width: 100%;
      }
      input[type="text"],
      select,
      textarea {
        background: #0b1323;
        border: 1px solid var(--line);
        color: var(--text);
        padding: 8px 10px;
        border-radius: 10px;
        outline: none;
        width: 100%;
      }
      textarea {
        min-height: 80px;
      }
      .btn {
        background: var(--accent);
        color: #fff;
        border: 0;
        border-radius: 10px;
        padding: 10px 14px;
        font-weight: 700;
        cursor: pointer;
      }
      .btn.secondary {
        background: #24365d;
      }
      .btn.ghost {
        background: transparent;
        border: 1px solid var(--line);
      }
      .muted {
        color: var(--muted);
      }
      .mt8 {
        margin-top: 8px;
      }
      .mt12 {
        margin-top: 12px;
      }
      .mt16 {
        margin-top: 16px;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        padding: 16px;
      }
      .status-dot {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #7381a3;
        margin-right: 6px;
      }
      .status-ok {
        background: var(--ok);
      }
      .status-err {
        background: var(--err);
      }
      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
      }
      .tab {
        padding: 10px 14px;
        border: 1px solid var(--line);
        border-radius: 10px;
        background: #0b1323;
        cursor: pointer;
      }
      .tab.active {
        background: var(--accent);
      }
      .col2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      .cols2 {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
      }
      hr {
        border: 0;
        border-top: 1px solid var(--line);
        margin: 12px 0;
      }
      .list {
        border: 1px solid var(--line);
        border-radius: 10px;
        overflow: hidden;
      }
      .item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        border-bottom: 1px solid var(--line);
      }
      .item:last-child {
        border-bottom: 0;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #0b1323;
        border: 1px solid var(--line);
        border-radius: 999px;
        padding: 6px 10px;
      }
      .led {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        margin-right: 10px;
      }
      .led .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #7381a3;
      }
      .led.ok .dot {
        background: var(--ok);
      }
      .led.err .dot {
        background: var(--err);
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>–ê–¥–º–∏–Ω–∫–∞ —Å–æ–±—ã—Ç–∏—è</h1>

      <!-- slug + token -->
      <div class="row kv" style="margin-bottom: 12px">
        <div class="muted">Event slug</div>
        <input id="slug" type="text" />
        <div class="muted">Admin token</div>
        <input id="token" type="text" placeholder="–≤—Å—Ç–∞–≤—å ADMIN_TOKEN" />
      </div>

      <!-- tabs -->
      <div class="tabs">
        <div class="tab" data-tab="dash">–°—Ç–∞—Ç—É—Å</div>
        <div class="tab" data-tab="conf">–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è</div>
        <div class="tab" data-tab="quiz">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤—ã</div>
        <div class="tab" data-tab="board">–õ–∏–¥–µ—Ä–±–æ—Ä–¥</div>
        <div class="tab" data-tab="people">–£—á–∞—Å—Ç–Ω–∏–∫–∏</div>
      </div>

      <!-- ====== –°—Ç–∞—Ç—É—Å ====== -->
      <section id="dash" class="card" style="display: none">
        <div class="row">
          <span id="sdot" class="status-dot"></span><strong>–°—Ç–∞—Ç—É—Å</strong>
          <span id="supdated" class="pill">‚Äî</span>
        </div>

        <div class="col2 mt12">
          <div class="card">
            <strong>–û–Ω–ª–∞–π–Ω</strong>
            <div class="mt8">–°–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω: <b id="d_online">0</b></div>
            <div>–í—Å–µ–≥–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ: <b id="d_total">0</b></div>
            <div class="row mt12">
              <button class="btn secondary" id="d_refresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
              <label class="row"
                ><input
                  type="checkbox"
                  id="d_auto"
                  checked
                  style="transform: scale(1.2); margin-right: 6px"
                />
                –∞–≤—Ç–æ</label
              >
            </div>
          </div>
          <div class="card">
            <strong>–¢–æ–ø-10</strong>
            <div class="list mt8" id="d_top"></div>
          </div>
        </div>
      </section>

      <!-- ====== –ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è ====== -->
      <section id="conf" class="card" style="display: none">
        <!-- read-only –±–ª–æ–∫ -->
        <div class="card">
          <div class="row">
            <span id="c_dot" class="status-dot"></span
            ><strong>–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å</strong>
            <span id="c_updated" class="pill">‚Äî</span>
          </div>
          <div class="mt12"><b>–§–∞–∑–∞:</b> <span id="c_phase">‚Äî</span></div>
          <div class="row mt8" id="c_flags">
            <span class="led" id="led_quiz"><span class="dot"></span>–ö–≤–∏–∑</span>
            <span class="led" id="led_logic"
              ><span class="dot"></span>–ì–¥–µ –ª–æ–≥–∏–∫–∞?</span
            >
            <span class="led" id="led_contact"
              ><span class="dot"></span>–ï—Å—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç!</span
            >
            <span class="led" id="led_100"
              ><span class="dot"></span>100 –∫ 1</span
            >
            <span class="led" id="led_auction"
              ><span class="dot"></span>–ê—É–∫—Ü–∏–æ–Ω</span
            >
          </div>
        </div>

        <hr />

        <!-- –§–æ—Ä–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <strong>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</strong>
        <div class="mt12 kv">
          <div class="muted">–§–∞–∑–∞</div>
          <select id="phase">
            <option value="lobby">lobby</option>
            <option value="quiz">quiz</option>
            <option value="logic">logic</option>
            <option value="contact">contact</option>
            <option value="onehundred">onehundred</option>
            <option value="auction">auction</option>
          </select>
        </div>
        <div class="mt12 cols2">
          <label><input id="f_quiz" type="checkbox" /> –ö–≤–∏–∑</label>
          <label><input id="f_logic" type="checkbox" /> –ì–¥–µ –ª–æ–≥–∏–∫–∞?</label>
          <label><input id="f_contact" type="checkbox" /> –ï—Å—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç!</label>
          <label><input id="f_100" type="checkbox" /> 100 –∫ 1</label>
          <label><input id="f_auction" type="checkbox" /> –ê—É–∫—Ü–∏–æ–Ω</label>
        </div>
        <div class="row mt12">
          <button class="btn ghost" id="btnLoadState">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
          <button class="btn" id="btnSaveState">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <span id="saveInfo" class="muted">‚Äî</span>
          <button
            class="btn secondary"
            id="btnOpenHall"
            style="margin-left: auto"
          >
            –û—Ç–∫—Ä—ã—Ç—å —ç–∫—Ä–∞–Ω –∑–∞–ª–∞
          </button>
        </div>
      </section>

      <!-- ====== –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤—ã ====== -->
      <section id="quiz" class="card" style="display: none">
        <div class="row">
          <strong>–ö–≤–∏–∑ ‚Äî —Ä–∞—É–Ω–¥—ã –∏ –≤–æ–ø—Ä–æ—Å—ã</strong>
          <span id="qInfo" class="muted" style="margin-left: 8px">‚Äî</span>
        </div>

        <div class="col2 mt12">
          <!-- Rounds -->
          <div class="card">
            <div class="row">
              <input
                id="qRoundTitle"
                type="text"
                placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—É–Ω–¥–∞"
              />
              <button class="btn" id="qRoundSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button class="btn secondary" id="qRoundOpen">–û—Ç–∫—Ä—ã—Ç—å</button>
              <button class="btn ghost" id="qRoundClose">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
            <div class="list mt12" id="qRounds"></div>
          </div>

          <!-- Questions -->
          <div class="card">
            <div class="muted">–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∞—É–Ω–¥: <b id="qCurrent">‚Äî</b></div>
            <div class="mt8">–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞</div>
            <textarea id="qText"></textarea>
            <div class="mt8 cols2">
              <input id="o1" type="text" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 1" />
              <input id="o2" type="text" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 2" />
              <input id="o3" type="text" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 3" />
              <input id="o4" type="text" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 4" />
            </div>
            <div class="mt8 kv">
              <div class="muted">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å</div>
              <input id="qCorrect" type="text" placeholder="0..3" />
            </div>
            <div class="row mt8">
              <button class="btn" id="qAdd">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
              <button class="btn secondary" id="qUpdate">
                –û–±–Ω–æ–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π
              </button>
              <button class="btn ghost" id="qDelete">–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π</button>
              <span id="qMsg" class="muted">‚Äî</span>
            </div>
            <div class="list mt12" id="qList"></div>

            <hr />
            <div class="row">
              <button class="btn" id="qStart">–°—Ç–∞—Ä—Ç —Ä–∞—É–Ω–¥–∞</button>
              <button class="btn secondary" id="qNext">–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å</button>
              <button class="btn secondary" id="qReveal">
                –ù–∞—á–∏—Å–ª–∏—Ç—å (+10)
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- ====== –õ–∏–¥–µ—Ä–±–æ—Ä–¥ ====== -->
      <section id="board" class="card" style="display: none">
        <strong>–õ–∏–¥–µ—Ä–±–æ—Ä–¥ (–ø—Ä–µ–≤—å—é)</strong>
        <div class="row mt12">
          <button class="btn secondary" id="bOpen">–û—Ç–∫—Ä—ã—Ç—å —ç–∫—Ä–∞–Ω –∑–∞–ª–∞</button>
          <button class="btn ghost" id="bReload">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <div class="list mt12" id="bList"></div>
      </section>
    </div>

    <section id="people" class="card" style="display: none">
      <div class="row">
        <strong>–£—á–∞—Å—Ç–Ω–∏–∫–∏ —Å–æ–±—ã—Ç–∏—è</strong>
        <span id="pInfo" class="muted">‚Äî</span>
      </div>

      <div class="row mt12" style="gap: 8px">
        <input
          id="pSearch"
          type="text"
          placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏/–Ω–∏–∫—É"
          style="max-width: 320px"
        />
        <select id="pSort">
          <option value="score|desc">–ü–æ –±–∞–ª–ª–∞–º ‚Üì</option>
          <option value="score|asc">–ü–æ –±–∞–ª–ª–∞–º ‚Üë</option>
          <option value="name|asc">–ü–æ –∏–º–µ–Ω–∏ A‚ÜíZ</option>
          <option value="name|desc">–ü–æ –∏–º–µ–Ω–∏ Z‚ÜíA</option>
          <option value="created|desc">–ù–µ–¥–∞–≤–Ω–æ</option>
          <option value="created|asc">–î–∞–≤–Ω–æ</option>
        </select>
        <button class="btn" id="pReload">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <div style="margin-left: auto"></div>
        <button class="btn secondary" id="pBonus10">–ë–æ–Ω—É—Å +10 –≤—Å–µ–º</button>
        <button class="btn ghost" id="pReset50">–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞ 50</button>
      </div>

      <div class="list mt12" id="pList"></div>
    </section>

    <script>
      // ===== helpers =====
      const $ = (s) => document.querySelector(s);
      const EVENT = () => $("#slug").value || "pr-demo";
      const TOKEN = () => $("#token").value || "";

      // persist slug/token
      (function bootstrapPersist() {
        const s = localStorage.getItem("adm_event_slug");
        const t = localStorage.getItem("adm_admin_token");
        if (s) $("#slug").value = s;
        else $("#slug").value = "pr-demo";
        if (t) $("#token").value = t;
        $("#slug").addEventListener("input", (e) =>
          localStorage.setItem("adm_event_slug", e.target.value)
        );
        $("#token").addEventListener("input", (e) =>
          localStorage.setItem("adm_admin_token", e.target.value)
        );
      })();

      // tabs
      const tabs = [...document.querySelectorAll(".tab")];
      function showTab(name) {
        tabs.forEach((t) =>
          t.classList.toggle("active", t.dataset.tab === name)
        );
        document
          .querySelectorAll("section")
          .forEach((s) => (s.style.display = s.id === name ? "block" : "none"));
        localStorage.setItem("adm_tab", name);
      }
      tabs.forEach((t) => (t.onclick = () => showTab(t.dataset.tab)));
      showTab(localStorage.getItem("adm_tab") || "dash");

      async function getJSON(path, headers = {}) {
        const r = await fetch(path, { headers });
        if (!r.ok) throw new Error(path + " " + r.status);
        return r.json();
      }
      async function postJSON(path, body, headers = {}) {
        const r = await fetch(path, {
          method: "POST",
          headers: { "Content-Type": "application/json", ...headers },
          body: JSON.stringify(body || {}),
        });
        if (!r.ok) throw new Error(path + " " + r.status);
        return r.json();
      }

      // ===== –°—Ç–∞—Ç—É—Å =====
      async function dashLoad() {
        // —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        try {
          const s = await getJSON(
            `/api/event/state.js?event_slug=${encodeURIComponent(EVENT())}`
          );
          $("#supdated").textContent =
            "updated_at: " + (s.state?.updated_at || "‚Äî");
          $("#sdot").classList.add("status-ok");
          $("#sdot").classList.remove("status-err");
        } catch {
          $("#sdot").classList.remove("status-ok");
          $("#sdot").classList.add("status-err");
        }
        // —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        const st = await getJSON(
          `/api/event/stats.js?event_slug=${encodeURIComponent(EVENT())}`
        );
        $("#d_online").textContent = st.online;
        $("#d_total").textContent = st.total_registered;
        $("#d_top").innerHTML =
          (st.top || [])
            .map(
              (r, i) =>
                `<div class="item"><div>#${i + 1} ‚Äî ${
                  r.display_name || "–ë–µ–∑ –∏–º–µ–Ω–∏"
                }</div><div>${r.score}</div></div>`
            )
            .join("") || `<div class="item">–ü—É—Å—Ç–æ</div>`;
      }
      $("#d_refresh").onclick = dashLoad;
      let dashTimer = setInterval(
        () => $("#d_auto").checked && dashLoad(),
        3000
      );
      $("#d_auto").onchange = () => {
        if (!$("#d_auto").checked) clearInterval(dashTimer);
        else
          dashTimer = setInterval(
            () => $("#d_auto").checked && dashLoad(),
            3000
          );
      };
      dashLoad();

      // ===== –ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è =====
      async function confRefreshReadonly() {
        try {
          const d = await getJSON(
            `/api/event/state.js?event_slug=${encodeURIComponent(EVENT())}`
          );
          const st = d.state || {};
          $("#c_phase").textContent = st.phase || "‚Äî";
          $("#c_updated").textContent = "updated_at: " + (st.updated_at || "‚Äî");
          const set = (id, ok) => {
            const el = $(id);
            el.classList.toggle("ok", ok);
            el.classList.toggle("err", !ok);
          };
          set("#led_quiz", !!st.quiz_open);
          set("#led_logic", !!st.logic_open);
          set("#led_contact", !!st.contact_open);
          set("#led_100", !!st.onehundred_open);
          set("#led_auction", !!st.auction_open);
          $("#c_dot").classList.add("status-ok");
          $("#c_dot").classList.remove("status-err");
        } catch {
          $("#c_dot").classList.remove("status-ok");
          $("#c_dot").classList.add("status-err");
        }
      }
      setInterval(confRefreshReadonly, 3000);
      confRefreshReadonly();

      $("#btnOpenHall").onclick = () =>
        window.open(
          `/hall.html?event=${encodeURIComponent(EVENT())}`,
          "_blank"
        );

      $("#btnLoadState").onclick = async () => {
        const d = await getJSON(
          `/api/event/state.js?event_slug=${encodeURIComponent(EVENT())}`
        );
        const st = d.state || {};
        $("#phase").value = st.phase || "lobby";
        $("#f_quiz").checked = !!st.quiz_open;
        $("#f_logic").checked = !!st.logic_open;
        $("#f_contact").checked = !!st.contact_open;
        $("#f_100").checked = !!st.onehundred_open;
        $("#f_auction").checked = !!st.auction_open;
        $("#saveInfo").textContent = "–ó–∞–≥—Ä—É–∂–µ–Ω–æ";
      };
      $("#btnSaveState").onclick = async () => {
        const patch = {
          phase: $("#phase").value,
          quiz_open: $("#f_quiz").checked,
          logic_open: $("#f_logic").checked,
          contact_open: $("#f_contact").checked,
          onehundred_open: $("#f_100").checked,
          auction_open: $("#f_auction").checked,
        };
        try {
          await postJSON(
            `/api/admin/state_set.js?event_slug=${encodeURIComponent(EVENT())}`,
            patch,
            { "x-admin-token": TOKEN() }
          );
          $("#saveInfo").textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úì";
          confRefreshReadonly();
        } catch {
          $("#saveInfo").textContent = "–û—à–∏–±–∫–∞";
        }
      };

      // ===== –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤—ã (–∫–≤–∏–∑) =====
      const LSK = "adm_quiz_draft_v1";
      const draft = {
        round_id: localStorage.getItem(LSK + "_round") || "",
        title: localStorage.getItem(LSK + "_title") || "",
        qText: localStorage.getItem(LSK + "_qText") || "",
        o1: localStorage.getItem(LSK + "_o1") || "",
        o2: localStorage.getItem(LSK + "_o2") || "",
        o3: localStorage.getItem(LSK + "_o3") || "",
        o4: localStorage.getItem(LSK + "_o4") || "",
        qCorrect: localStorage.getItem(LSK + "_qCorrect") || "",
      };
      $("#qRoundTitle").value = draft.title;
      $("#qText").value = draft.qText;
      ["o1", "o2", "o3", "o4"].forEach((id) => ($("#" + id).value = draft[id]));
      $("#qCorrect").value = draft.qCorrect;
      $("#qCurrent").textContent = draft.round_id || "‚Äî";
      ["qRoundTitle", "qText", "o1", "o2", "o3", "o4", "qCorrect"].forEach(
        (id) => {
          $("#" + id).addEventListener("input", (e) =>
            localStorage.setItem(
              LSK + "_" + id.replace(/^q/, "q").replace(/^o/, "o"),
              e.target.value
            )
          );
        }
      );

      async function loadRounds() {
        const j = await getJSON(
          `/api/quiz.js?action=admin_rounds&event_slug=${encodeURIComponent(
            EVENT()
          )}`
        );
        $("#qRounds").innerHTML =
          (j.rounds || [])
            .map(
              (r) => `
        <div class="item">
          <div>#${r.id} ‚Äî ${r.title} ${
                r.is_open ? '<span class="pill">open</span>' : ""
              }</div>
          <div class="row"><button class="btn secondary" onclick="pickRound(${
            r.id
          }, '${encodeURIComponent(r.title)}')">–í—ã–±—Ä–∞—Ç—å</button></div>
        </div>`
            )
            .join("") || `<div class="item">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞—É–Ω–¥–æ–≤</div>`;
      }
      window.pickRound = async (id, encTitle) => {
        draft.round_id = id;
        localStorage.setItem(LSK + "_round", id);
        const t = decodeURIComponent(encTitle);
        $("#qCurrent").textContent = id;
        $("#qRoundTitle").value = t;
        localStorage.setItem(LSK + "_title", t);
        loadQuestions();
      };

      async function loadQuestions() {
        $("#qList").innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        if (!draft.round_id)
          return ($("#qList").innerHTML = "–í—ã–±–µ—Ä–∏ —Ä–∞—É–Ω–¥ —Å–ª–µ–≤–∞");
        const j = await getJSON(
          `/api/quiz.js?action=admin_questions&event_slug=${encodeURIComponent(
            EVENT()
          )}&round_id=${draft.round_id}`
        );
        $("#qList").innerHTML =
          (j.questions || [])
            .map(
              (q) => `
        <div class="item">
          <div>#${q.q_index + 1}. ${q.text}</div>
          <div class="row">
            <button class="btn ghost" onclick='fillQ(${q.id},${
                q.q_index
              },${JSON.stringify(q.options).replace(/'/g, "&apos;")},${
                q.correct_index
              },${JSON.stringify(q.text).replace(
                /'/g,
                "&apos;"
              )})'>–†–µ–¥–∞–∫—Ç.</button>
            <button class="btn secondary" onclick='delQ(${
              q.id
            })'>–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>`
            )
            .join("") || `<div class="item">–ü–æ–∫–∞ –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤</div>`;
      }
      window.fillQ = (id, idx, opts, correct, text) => {
        $("#qText").value = text;
        localStorage.setItem(LSK + "_qText", text);
        ["o1", "o2", "o3", "o4"].forEach((k, i) => {
          $("#" + k).value = opts[i] ?? "";
          localStorage.setItem(LSK + "_" + k, $("#" + k).value);
        });
        $("#qCorrect").value = correct;
        localStorage.setItem(LSK + "_qCorrect", correct);
        $("#qMsg").textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –≤–æ–ø—Ä–æ—Å #${idx + 1} (id:${id})`;
        window.__editingQ = id;
      };
      window.delQ = async (id) => {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å?")) return;
        await postJSON(
          `/api/quiz.js?action=admin_question_delete&event_slug=${encodeURIComponent(
            EVENT()
          )}`,
          { id },
          { "x-admin-token": TOKEN() }
        );
        loadQuestions();
      };

      $("#qRoundSave").onclick = async () => {
        const title = $("#qRoundTitle").value.trim();
        if (!title) return ($("#qInfo").textContent = "–ù–∞–∑–≤–∞–Ω–∏–µ –ø—É—Å—Ç–æ");
        const body = draft.round_id
          ? { id: Number(draft.round_id), title }
          : { title };
        const j = await postJSON(
          `/api/quiz.js?action=admin_round_upsert&event_slug=${encodeURIComponent(
            EVENT()
          )}`,
          body,
          { "x-admin-token": TOKEN() }
        );
        draft.round_id = j.id;
        localStorage.setItem(LSK + "_round", draft.round_id);
        $("#qCurrent").textContent = draft.round_id;
        $("#qInfo").textContent = "–†–∞—É–Ω–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω";
        loadRounds();
        loadQuestions();
      };
      $("#qRoundOpen").onclick = async () => {
        if (!draft.round_id) return alert("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π/–≤—ã–±–µ—Ä–∏ —Ä–∞—É–Ω–¥");
        await postJSON(
          `/api/quiz.js?action=admin_round_open&event_slug=${encodeURIComponent(
            EVENT()
          )}`,
          { id: Number(draft.round_id) },
          { "x-admin-token": TOKEN() }
        );
        loadRounds();
        $("#qInfo").textContent = "–†–∞—É–Ω–¥ –æ—Ç–∫—Ä—ã—Ç";
      };
      $("#qRoundClose").onclick = async () => {
        if (!draft.round_id) return;
        await postJSON(
          `/api/quiz.js?action=admin_round_close&event_slug=${encodeURIComponent(
            EVENT()
          )}`,
          { id: Number(draft.round_id) },
          { "x-admin-token": TOKEN() }
        );
        loadRounds();
        $("#qInfo").textContent = "–†–∞—É–Ω–¥ –∑–∞–∫—Ä—ã—Ç";
      };

      $("#qAdd").onclick = async () => {
        if (!draft.round_id) return alert("–í—ã–±–µ—Ä–∏ —Ä–∞—É–Ω–¥");
        const options = [
          $("#o1").value,
          $("#o2").value,
          $("#o3").value,
          $("#o4").value,
        ].filter(Boolean);
        const correct = Number($("#qCorrect").value || 0);
        const text = $("#qText").value.trim();
        await postJSON(
          `/api/quiz.js?action=admin_question_add&event_slug=${encodeURIComponent(
            EVENT()
          )}`,
          {
            round_id: Number(draft.round_id),
            text,
            options,
            correct_index: correct,
          },
          { "x-admin-token": TOKEN() }
        );
        $("#qMsg").textContent = "–î–æ–±–∞–≤–ª–µ–Ω–æ";
        window.__editingQ = null;
        loadQuestions();
      };
      $("#qUpdate").onclick = async () => {
        if (!window.__editingQ) return alert("–í—ã–±–µ—Ä–∏ –≤–æ–ø—Ä–æ—Å –∫–Ω–æ–ø–∫–æ–π ¬´–†–µ–¥–∞–∫—Ç.¬ª");
        const options = [
          $("#o1").value,
          $("#o2").value,
          $("#o3").value,
          $("#o4").value,
        ].filter(Boolean);
        const correct = Number($("#qCorrect").value || 0);
        const text = $("#qText").value.trim();
        await postJSON(
          `/api/quiz.js?action=admin_question_update&event_slug=${encodeURIComponent(
            EVENT()
          )}`,
          {
            id: Number(window.__editingQ),
            text,
            options,
            correct_index: correct,
          },
          { "x-admin-token": TOKEN() }
        );
        $("#qMsg").textContent = "–û–±–Ω–æ–≤–ª–µ–Ω–æ";
        loadQuestions();
      };

      $("#qStart").onclick = async () => {
        await postJSON(
          `/api/quiz.js?action=admin_start&event_slug=${encodeURIComponent(
            EVENT()
          )}`,
          { round_id: Number(draft.round_id) },
          { "x-admin-token": TOKEN() }
        );
        $("#qInfo").textContent = "–†–∞—É–Ω–¥ –æ—Ç–∫—Ä—ã—Ç";
      };
      $("#qNext").onclick = async () => {
        await postJSON(
          `/api/quiz.js?action=admin_next&event_slug=${encodeURIComponent(
            EVENT()
          )}`,
          {},
          { "x-admin-token": TOKEN() }
        );
        $("#qInfo").textContent = "–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å";
      };
      $("#qReveal").onclick = async () => {
        const j = await postJSON(
          `/api/quiz.js?action=admin_reveal&event_slug=${encodeURIComponent(
            EVENT()
          )}`,
          {},
          { "x-admin-token": TOKEN() }
        );
        $("#qInfo").textContent = "–ù–∞—á–∏—Å–ª–µ–Ω–æ: " + (j.awarded || 0);
      };
      loadRounds();
      if (draft.round_id) loadQuestions();

      // ===== –õ–∏–¥–µ—Ä–±–æ—Ä–¥ =====
      async function boardLoad() {
        const j = await getJSON(
          `/api/leaderboard.js?event_slug=${encodeURIComponent(
            EVENT()
          )}&limit=10`
        );
        $("#bList").innerHTML =
          (j.top || [])
            .map(
              (r, i) =>
                `<div class="item"><div>#${i + 1} ‚Äî ${
                  r.display_name || "–ë–µ–∑ –∏–º–µ–Ω–∏"
                }</div><div>${r.score}</div></div>`
            )
            .join("") || `<div class="item">–ü—É—Å—Ç–æ</div>`;
      }
      $("#bOpen").onclick = () =>
        window.open(
          `/hall.html?event=${encodeURIComponent(EVENT())}`,
          "_blank"
        );
      $("#bReload").onclick = boardLoad;
      boardLoad();

      async function pLoad() {
        const [sortKey, sortDir] = ($("#pSort").value || "score|desc").split(
          "|"
        );
        const q = $("#pSearch").value.trim();
        const j = await getJSON(
          `/api/participants.js?action=list&event_slug=${encodeURIComponent(
            EVENT()
          )}` +
            `&sort=${encodeURIComponent(sortKey)}&order=${encodeURIComponent(
              sortDir
            )}` +
            (q ? `&q=${encodeURIComponent(q)}` : ``)
        );
        $("#pInfo").textContent = `–í—Å–µ–≥–æ: ${j.total}`;
        $("#pList").innerHTML =
          (j.items || [])
            .map(
              (r) => `
      <div class="item">
        <div class="row" style="gap:10px">
          <div style="width:28px;height:28px;border-radius:50%;background:#0b1323;display:flex;align-items:center;justify-content:center">${
            r.avatar_url || "üôÇ"
          }</div>
          <div>
            <div><b>${r.display_name || "–ë–µ–∑ –∏–º–µ–Ω–∏"}</b> <span class="muted">@${
                r.username || "-"
              }</span></div>
            <div class="muted">tg: ${r.tg_id || "-"}</div>
          </div>
        </div>
        <div class="row" style="gap:8px">
          <div class="pill">–ë–∞–ª–ª—ã: <b>${r.score}</b></div>
          <button class="btn secondary" onclick="pAdj(${
            r.participant_id
          }, 10)">+10</button>
          <button class="btn secondary" onclick="pAdj(${
            r.participant_id
          }, -10)">-10</button>
          <button class="btn ghost" onclick="pSet(${
            r.participant_id
          })">=</button>
          <button class="btn ghost" onclick="pKick(${
            r.participant_id
          })">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>`
            )
            .join("") || `<div class="item">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>`;
      }
      $("#pReload").onclick = pLoad;
      $("#pSort").onchange = pLoad;
      $("#pSearch").oninput = () => {
        clearTimeout(window.__pT);
        window.__pT = setTimeout(pLoad, 300);
      };

      window.pAdj = async (id, delta) => {
        await postJSON(
          `/api/participants.js?action=adjust&event_slug=${encodeURIComponent(
            EVENT()
          )}`,
          { participant_id: id, delta },
          { "x-admin-token": TOKEN() }
        );
        pLoad();
      };
      window.pSet = async (id) => {
        const v = prompt("–í—ã—Å—Ç–∞–≤–∏—Ç—å –±–∞–ª–ª—ã =", "50");
        if (v == null) return;
        const score = Number(v);
        if (!Number.isFinite(score)) return alert("–ù—É–∂–Ω–æ —á–∏—Å–ª–æ");
        await postJSON(
          `/api/participants.js?action=set&event_slug=${encodeURIComponent(
            EVENT()
          )}`,
          { participant_id: id, score },
          { "x-admin-token": TOKEN() }
        );
        pLoad();
      };
      window.pKick = async (id) => {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–∑ —Å–æ–±—ã—Ç–∏—è?")) return;
        await postJSON(
          `/api/participants.js?action=kick&event_slug=${encodeURIComponent(
            EVENT()
          )}`,
          { participant_id: id },
          { "x-admin-token": TOKEN() }
        );
        pLoad();
      };

      $("#pBonus10").onclick = async () => {
        if (!confirm("–ù–∞—á–∏—Å–ª–∏—Ç—å –≤—Å–µ–º +10?")) return;
        await postJSON(
          `/api/participants.js?action=bonus_all&event_slug=${encodeURIComponent(
            EVENT()
          )}`,
          { delta: 10 },
          { "x-admin-token": TOKEN() }
        );
        pLoad();
      };
      $("#pReset50").onclick = async () => {
        if (!confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ–º –Ω–∞ 50?")) return;
        await postJSON(
          `/api/participants.js?action=reset_scores&event_slug=${encodeURIComponent(
            EVENT()
          )}`,
          { to: 50 },
          { "x-admin-token": TOKEN() }
        );
        pLoad();
      };

      // –∞–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –ø–æ—ç—Ç–æ–º—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ –ø–æ–¥–≥—Ä—É–∑–∏–º, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –≤–∫–ª–∞–¥–∫–∞
      if (localStorage.getItem("adm_tab") === "people") pLoad();
    </script>
  </body>
</html>
