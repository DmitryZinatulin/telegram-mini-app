<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Admin • Pernod Ricard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{ --bg:#0b1020; --card:#121a2a; --text:#e9eefc; --muted:#96a0b8; --accent:#4c8dff; --ok:#39d98a; --err:#ff6b6b; --line:#1e2840;}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:1180px;margin:24px auto;padding:0 16px}
  h1{font-size:20px;margin:0 0 16px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:8px;align-items:center;width:100%}
  input[type="text"], select, textarea{background:#0b1323;border:1px solid var(--line);color:var(--text);padding:8px 10px;border-radius:10px;outline:none;width:100%}
  textarea{min-height:80px}
  .btn{background:var(--accent);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.secondary{background:#24365d}
  .btn.ghost{background:transparent;border:1px solid var(--line)}
  .muted{color:var(--muted)} .mt8{margin-top:8px} .mt12{margin-top:12px} .mt16{margin-top:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:16px}
  .status-dot{display:inline-block;width:10px;height:10px;border-radius:50%;background:#7381a3;margin-right:6px}
  .status-ok{background:var(--ok)} .status-err{background:var(--err)}
  .tabs{display:flex;gap:8px;margin-bottom:12px}
  .tab{padding:10px 14px;border:1px solid var(--line);border-radius:10px;background:#0b1323;cursor:pointer}
  .tab.active{background:var(--accent)}
  .col2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .cols2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  hr{border:0;border-top:1px solid var(--line);margin:12px 0}
  .list{border:1px solid var(--line);border-radius:10px;overflow:hidden}
  .item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--line)}
  .item:last-child{border-bottom:0}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#0b1323;border:1px solid var(--line);border-radius:999px;padding:6px 10px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Админка события</h1>

  <div class="row kv" style="margin-bottom:12px">
    <div class="muted">Event slug</div>
    <input id="slug" type="text" value="pr-demo">
    <div class="muted">Admin token</div>
    <input id="token" type="text" placeholder="вставь ADMIN_TOKEN">
  </div>

  <div class="tabs">
    <div class="tab" data-tab="dash">Дашборд</div>
    <div class="tab" data-tab="state">Состояние</div>
    <div class="tab" data-tab="quiz">Квиз</div>
    <div class="tab" data-tab="board">Лидерборд</div>
  </div>

  <!-- DASH -->
  <section id="dash" class="card" style="display:none">
    <div class="row">
      <span id="sdot" class="status-dot"></span><strong>Статус</strong>
      <span id="supdated" class="pill">—</span>
    </div>

    <div class="col2 mt12">
      <div class="card">
        <strong>Онлайн</strong>
        <div class="mt8">Сейчас онлайн: <b id="d_online">0</b></div>
        <div>Всего зарегистрировано: <b id="d_total">0</b></div>
        <div class="row mt12"><button class="btn secondary" id="d_refresh">Обновить</button>
          <label class="row"><input type="checkbox" id="d_auto" checked style="transform:scale(1.2);margin-right:6px"> авто</label>
        </div>
      </div>
      <div class="card">
        <strong>Топ-10</strong>
        <div class="list mt8" id="d_top"></div>
      </div>
    </div>
  </section>

  <!-- STATE -->
  <section id="state" class="card" style="display:none">
    <div class="row">
      <span id="statusDot" class="status-dot"></span><strong>Состояние события</strong>
      <span class="pill" id="updated">—</span>
    </div>

    <div class="mt12 kv">
      <div class="muted">Текущая фаза</div><div id="st_phase">—</div>
    </div>
    <div class="mt12 cols2">
      <div><input type="checkbox" id="st_quiz" disabled> <label for="st_quiz">Квиз</label></div>
      <div><input type="checkbox" id="st_logic" disabled> <label for="st_logic">Где логика?</label></div>
      <div><input type="checkbox" id="st_contact" disabled> <label for="st_contact">Есть контакт!</label></div>
      <div><input type="checkbox" id="st_100" disabled> <label for="st_100">100 к 1</label></div>
      <div><input type="checkbox" id="st_auction" disabled> <label for="st_auction">Аукцион</label></div>
    </div>

    <hr>

    <strong>Управление</strong>
    <div class="mt12 kv">
      <div class="muted">Фаза</div>
      <select id="phase">
        <option value="lobby">lobby</option><option value="quiz">quiz</option>
        <option value="logic">logic</option><option value="contact">contact</option>
        <option value="onehundred">onehundred</option><option value="auction">auction</option>
      </select>
    </div>
    <div class="mt12 cols2">
      <div><input id="f_quiz" type="checkbox"> <label for="f_quiz">Квиз</label></div>
      <div><input id="f_logic" type="checkbox"> <label for="f_logic">Где логика?</label></div>
      <div><input id="f_contact" type="checkbox"> <label for="f_contact">Есть контакт!</label></div>
      <div><input id="f_100" type="checkbox"> <label for="f_100">100 к 1</label></div>
      <div><input id="f_auction" type="checkbox"> <label for="f_auction">Аукцион</label></div>
    </div>
    <div class="row mt12">
      <button class="btn ghost" id="btnLoadState">Загрузить</button>
      <button class="btn" id="btnSaveState">Сохранить</button>
      <span id="saveInfo" class="muted">—</span>
      <button class="btn secondary" id="btnOpenHall" style="margin-left:auto">Открыть экран зала</button>
    </div>
  </section>

  <!-- QUIZ -->
  <section id="quiz" class="card" style="display:none">
    <div class="row"><strong>Квиз — раунды и вопросы</strong>
      <span id="qInfo" class="muted" style="margin-left:8px">—</span></div>

    <div class="col2 mt12">
      <!-- ROUNDS -->
      <div class="card">
        <div class="row">
          <input id="qRoundTitle" type="text" placeholder="Название раунда">
          <button class="btn" id="qRoundSave">Сохранить</button>
          <button class="btn secondary" id="qRoundOpen">Открыть</button>
          <button class="btn ghost" id="qRoundClose">Закрыть</button>
        </div>
        <div class="list mt12" id="qRounds"></div>
      </div>
      <!-- QUESTIONS -->
      <div class="card">
        <div class="muted">Выбранный раунд: <b id="qCurrent">—</b></div>
        <div class="mt8">Текст вопроса</div>
        <textarea id="qText"></textarea>
        <div class="mt8 cols2">
          <input id="o1" type="text" placeholder="Вариант 1">
          <input id="o2" type="text" placeholder="Вариант 2">
          <input id="o3" type="text" placeholder="Вариант 3">
          <input id="o4" type="text" placeholder="Вариант 4">
        </div>
        <div class="mt8 kv">
          <div class="muted">Правильный индекс</div>
          <input id="qCorrect" type="text" placeholder="0..3">
        </div>
        <div class="row mt8">
          <button class="btn" id="qAdd">Добавить вопрос</button>
          <button class="btn secondary" id="qUpdate">Обновить выбранный</button>
          <button class="btn ghost" id="qDelete">Удалить выбранный</button>
          <span id="qMsg" class="muted">—</span>
        </div>
        <div class="list mt12" id="qList"></div>

        <hr>
        <div class="row">
          <button class="btn" id="qStart">Старт раунда</button>
          <button class="btn secondary" id="qNext">Следующий вопрос</button>
          <button class="btn secondary" id="qReveal">Начислить (+10)</button>
        </div>
      </div>
    </div>
  </section>

  <!-- BOARD -->
  <section id="board" class="card" style="display:none">
    <strong>Лидерборд (превью)</strong>
    <div class="row mt12">
      <button class="btn secondary" id="bOpen">Открыть экран зала</button>
      <button class="btn ghost" id="bReload">Обновить</button>
    </div>
    <div class="list mt12" id="bList"></div>
  </section>
</div>

<script>
  const $ = (s)=>document.querySelector(s);
  const EVENT = () => $('#slug').value || 'pr-demo';
  const TOKEN = () => $('#token').value || '';

  // --------- tabs + persist ---------
  const tabs = [...document.querySelectorAll('.tab')];
  function showTab(name){
    tabs.forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
    document.querySelectorAll('section').forEach(s=>s.style.display = (s.id===name)?'block':'none');
    localStorage.setItem('adm_tab', name);
  }
  tabs.forEach(t=>t.onclick = ()=>showTab(t.dataset.tab));
  showTab(localStorage.getItem('adm_tab') || 'dash');

  // --------- helpers ---------
  async function getJSON(path){ const r = await fetch(path); if(!r.ok) throw new Error(path); return r.json(); }
  async function postJSON(path, body, headers={}){
    const r = await fetch(path, { method:'POST', headers:{'Content-Type':'application/json', ...headers}, body: JSON.stringify(body || {}) });
    if(!r.ok) throw new Error(path + ' ' + r.status);
    return r.json();
  }

  // --------- DASHBOARD ---------
  async function dashLoad(){
    // status state
    try{
      const s = await getJSON(`/api/event/state.js?event_slug=${encodeURIComponent(EVENT())}`);
      $('#supdated').textContent = 'updated_at: ' + (s.state?.updated_at || '—');
      $('#sdot').classList.add('status-ok'); $('#sdot').classList.remove('status-err');
    }catch{ $('#sdot').classList.remove('status-ok'); $('#sdot').classList.add('status-err'); }
    // stats + top
    const st = await getJSON('/api/stats.js');
    $('#d_online').textContent = st.online;
    $('#d_total').textContent = st.total;
    $('#d_top').innerHTML = (st.leaderboard||[]).slice(0,10).map((r,i)=>(
      `<div class="item"><div>#${i+1} — ${r.display_name||'Без имени'}</div><div>${r.score}</div></div>`
    )).join('') || `<div class="item">Пусто</div>`;
  }
  $('#d_refresh').onclick = dashLoad;
  let dashTimer = setInterval(()=>$('#d_auto').checked && dashLoad(), 3000);
  $('#d_auto').onchange = ()=>{ if(!$('#d_auto').checked) clearInterval(dashTimer); else dashTimer = setInterval(()=>$('#d_auto').checked && dashLoad(),3000); };
  dashLoad();

  // --------- STATE (read-only + control) ---------
  async function stateRefresh(){
    try{
      const d = await getJSON(`/api/event/state.js?event_slug=${encodeURIComponent(EVENT())}`);
      const st = d.state || {};
      $('#st_phase').textContent = st.phase || '—';
      $('#st_quiz').checked = !!st.quiz_open; $('#st_logic').checked = !!st.logic_open;
      $('#st_contact').checked = !!st.contact_open; $('#st_100').checked = !!st.onehundred_open; $('#st_auction').checked = !!st.auction_open;
      $('#updated').textContent = 'updated_at: ' + (st.updated_at || '—');
      $('#statusDot').classList.add('status-ok'); $('#statusDot').classList.remove('status-err');
    }catch{ $('#statusDot').classList.remove('status-ok'); $('#statusDot').classList.add('status-err'); }
  }
  $('#btnOpenHall').onclick = ()=> window.open(`/hall.html?event=${encodeURIComponent(EVENT())}`,'_blank');

  $('#btnLoadState').onclick = async ()=>{
    const d = await getJSON(`/api/event/state.js?event_slug=${encodeURIComponent(EVENT())}`);
    const st = d.state || {};
    $('#phase').value = st.phase || 'lobby';
    $('#f_quiz').checked = !!st.quiz_open; $('#f_logic').checked = !!st.logic_open;
    $('#f_contact').checked = !!st.contact_open; $('#f_100').checked = !!st.onehundred_open; $('#f_auction').checked = !!st.auction_open;
    $('#saveInfo').textContent = 'Загружено';
  };
  $('#btnSaveState').onclick = async ()=>{
    const patch = {
      phase: $('#phase').value,
      quiz_open: $('#f_quiz').checked, logic_open: $('#f_logic').checked,
      contact_open: $('#f_contact').checked, onehundred_open: $('#f_100').checked, auction_open: $('#f_auction').checked
    };
    try{
      await postJSON(`/api/admin/state_set.js?event_slug=${encodeURIComponent(EVENT())}`, patch, { 'x-admin-token': TOKEN() });
      $('#saveInfo').textContent = 'Сохранено ✓';
      stateRefresh();
    }catch{ $('#saveInfo').textContent = 'Ошибка'; }
  };
  stateRefresh();

  // --------- QUIZ: UI + localStorage ---------
  const LSK = 'adm_quiz_draft_v1';
  const draft = {
    round_id: localStorage.getItem(LSK+'_round') || '',
    title: localStorage.getItem(LSK+'_title') || '',
    qText: localStorage.getItem(LSK+'_qText') || '',
    o1: localStorage.getItem(LSK+'_o1') || '',
    o2: localStorage.getItem(LSK+'_o2') || '',
    o3: localStorage.getItem(LSK+'_o3') || '',
    o4: localStorage.getItem(LSK+'_o4') || '',
    qCorrect: localStorage.getItem(LSK+'_qCorrect') || ''
  };
  $('#qRoundTitle').value = draft.title;
  $('#qText').value = draft.qText; ['o1','o2','o3','o4'].forEach(id=> $('#'+id).value = draft[id]);
  $('#qCorrect').value = draft.qCorrect; $('#qCurrent').textContent = draft.round_id || '—';

  ['qRoundTitle','qText','o1','o2','o3','o4','qCorrect'].forEach(id=>{
    $('#'+id).addEventListener('input', e=> localStorage.setItem(LSK + '_' + id.replace(/^q/,'q').replace(/^o/,'o'), e.target.value));
  });

  async function loadRounds(){
    const j = await getJSON(`/api/quiz.js?action=admin_rounds&event_slug=${encodeURIComponent(EVENT())}`, { });
    $('#qRounds').innerHTML = (j.rounds||[]).map(r=>`
      <div class="item">
        <div>#${r.id} — ${r.title} ${r.is_open?'<span class="pill">open</span>':''}</div>
        <div class="row">
          <button class="btn secondary" onclick="pickRound(${r.id}, '${encodeURIComponent(r.title)}')">Выбрать</button>
        </div>
      </div>
    `).join('') || `<div class="item">Пока нет раундов</div>`;
  }
  window.pickRound = async (id, encTitle) => {
    draft.round_id = id; localStorage.setItem(LSK+'_round', id);
    const t = decodeURIComponent(encTitle);
    $('#qCurrent').textContent = id; $('#qRoundTitle').value = t; localStorage.setItem(LSK+'_title', t);
    loadQuestions();
  };

  async function loadQuestions(){
    $('#qList').innerHTML = 'Загрузка...';
    if (!draft.round_id) return $('#qList').innerHTML = 'Выбери раунд слева';
    const j = await getJSON(`/api/quiz.js?action=admin_questions&event_slug=${encodeURIComponent(EVENT())}&round_id=${draft.round_id}`);
    $('#qList').innerHTML = (j.questions||[]).map(q=>`
      <div class="item">
        <div>#${q.q_index+1}. ${q.text}</div>
        <div class="row">
          <button class="btn ghost" onclick='fillQ(${q.id}, ${q.q_index}, ${JSON.stringify(q.options).replace(/'/g,"&apos;")}, ${q.correct_index}, ${JSON.stringify(q.text).replace(/'/g,"&apos;")})'>Редакт.</button>
          <button class="btn secondary" onclick='delQ(${q.id})'>Удалить</button>
        </div>
      </div>
    `).join('') || `<div class="item">Пока нет вопросов</div>`;
  }
  window.fillQ = (id, idx, opts, correct, text) => {
    $('#qText').value = text; localStorage.setItem(LSK+'_qText', text);
    ['o1','o2','o3','o4'].forEach((k,i)=>{ $('#'+k).value = opts[i] ?? ''; localStorage.setItem(LSK+'_'+k, $('#'+k).value); });
    $('#qCorrect').value = correct; localStorage.setItem(LSK+'_qCorrect', correct);
    $('#qMsg').textContent = `Редактируем вопрос #${idx+1} (id:${id})`;
    window.__editingQ = id;
  };
  window.delQ = async (id) => {
    if (!confirm('Удалить вопрос?')) return;
    await postJSON(`/api/quiz.js?action=admin_question_delete&event_slug=${encodeURIComponent(EVENT())}`, { id }, { 'x-admin-token': TOKEN() });
    loadQuestions();
  };

  $('#qRoundSave').onclick = async ()=>{
    const title = $('#qRoundTitle').value.trim();
    if (!title) return $('#qInfo').textContent = 'Название пусто';
    const body = draft.round_id ? { id: Number(draft.round_id), title } : { title };
    const j = await postJSON(`/api/quiz.js?action=admin_round_upsert&event_slug=${encodeURIComponent(EVENT())}`, body, { 'x-admin-token': TOKEN() });
    draft.round_id = j.id; localStorage.setItem(LSK+'_round', draft.round_id);
    $('#qCurrent').textContent = draft.round_id;
    $('#qInfo').textContent = 'Раунд сохранён';
    loadRounds(); loadQuestions();
  };
  $('#qRoundOpen').onclick = async ()=>{
    if (!draft.round_id) return alert('Сначала создай/выбери раунд');
    await postJSON(`/api/quiz.js?action=admin_round_open&event_slug=${encodeURIComponent(EVENT())}`, { id: Number(draft.round_id) }, { 'x-admin-token': TOKEN() });
    loadRounds(); $('#qInfo').textContent = 'Раунд открыт';
  };
  $('#qRoundClose').onclick = async ()=>{
    if (!draft.round_id) return;
    await postJSON(`/api/quiz.js?action=admin_round_close&event_slug=${encodeURIComponent(EVENT())}`, { id: Number(draft.round_id) }, { 'x-admin-token': TOKEN() });
    loadRounds(); $('#qInfo').textContent = 'Раунд закрыт';
  };

  $('#qAdd').onclick = async ()=>{
    if (!draft.round_id) return alert('Выбери раунд');
    const options = [$('#o1').value,$('#o2').value,$('#o3').value,$('#o4').value].filter(Boolean);
    const correct = Number($('#qCorrect').value || 0);
    const text = $('#qText').value.trim();
    await postJSON(`/api/quiz.js?action=admin_question_add&event_slug=${encodeURIComponent(EVENT())}`,
      { round_id: Number(draft.round_id), text, options, correct_index: correct }, { 'x-admin-token': TOKEN() });
    $('#qMsg').textContent = 'Добавлено'; window.__editingQ = null;
    loadQuestions();
  };
  $('#qUpdate').onclick = async ()=>{
    if (!window.__editingQ) return alert('Выбери вопрос кнопкой «Редакт.»');
    const options = [$('#o1').value,$('#o2').value,$('#o3').value,$('#o4').value].filter(Boolean);
    const correct = Number($('#qCorrect').value || 0);
    const text = $('#qText').value.trim();
    await postJSON(`/api/quiz.js?action=admin_question_update&event_slug=${encodeURIComponent(EVENT())}`,
      { id: Number(window.__editingQ), text, options, correct_index: correct }, { 'x-admin-token': TOKEN() });
    $('#qMsg').textContent = 'Обновлено';
    loadQuestions();
  };

  $('#qStart').onclick  = async ()=>{ await postJSON(`/api/quiz.js?action=admin_start&event_slug=${encodeURIComponent(EVENT())}`, { round_id: Number(draft.round_id) }, { 'x-admin-token': TOKEN() }); $('#qInfo').textContent='Раунд открыт'; };
  $('#qNext').onclick   = async ()=>{ await postJSON(`/api/quiz.js?action=admin_next&event_slug=${encodeURIComponent(EVENT())}`, {}, { 'x-admin-token': TOKEN() }); $('#qInfo').textContent='Следующий вопрос'; };
  $('#qReveal').onclick = async ()=>{ const j=await postJSON(`/api/quiz.js?action=admin_reveal&event_slug=${encodeURIComponent(EVENT())}`, {}, { 'x-admin-token': TOKEN() }); $('#qInfo').textContent='Начислено: '+(j.awarded||0); };

  loadRounds(); if (draft.round_id) loadQuestions();

  // --------- BOARD PREVIEW ---------
  async function boardLoad(){
    const j = await getJSON(`/api/leaderboard.js?event_slug=${encodeURIComponent(EVENT())}&limit=10`);
    $('#bList').innerHTML = (j.top||[]).map((r,i)=>`<div class="item"><div>#${i+1} — ${r.display_name||'Без имени'}</div><div>${r.score}</div></div>`).join('') || `<div class="item">Пусто</div>`;
  }
  $('#bOpen').onclick = ()=> window.open(`/hall.html?event=${encodeURIComponent(EVENT())}`,'_blank');
  $('#bReload').onclick = boardLoad;
  boardLoad();
</script>
</body>
</html>
